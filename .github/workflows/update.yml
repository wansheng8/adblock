name: æ›´æ–°å¹¿å‘Šè¿‡æ»¤è§„åˆ™

on:
  schedule:
    # æ¯å¤©UTC 18:00 (åŒ—äº¬æ—¶é—´02:00)
    - cron: '0 18 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  generate-rules:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests PyYAML urllib3
    
    - name: åˆ›å»ºç›®å½•
      run: |
        mkdir -p rules/sources rules/outputs logs reports backups
    
    - name: æ£€æŸ¥æºæ–‡ä»¶
      run: |
        echo "ğŸ“ æ£€æŸ¥æºæ–‡ä»¶:"
        if [ -f "rules/sources/black.txt" ]; then
          echo "âœ… black.txt å­˜åœ¨"
          echo "æ–‡ä»¶è¡Œæ•°: $(wc -l < rules/sources/black.txt)"
          echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          head -10 rules/sources/black.txt
        else
          echo "âŒ black.txt ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹æ–‡ä»¶"
          cat > rules/sources/black.txt << 'EOF'
# å¹¿å‘Šè¿‡æ»¤è§„åˆ™æº
# è¯·åœ¨æ­¤æ–‡ä»¶ä¸­æ·»åŠ æ‚¨è¦é‡‡é›†çš„é»‘åå•è§„åˆ™æºURL
# æ¯è¡Œä¸€ä¸ªURLï¼Œä»¥#å¼€å¤´çš„è¡Œæ˜¯æ³¨é‡Š

# ç¤ºä¾‹ï¼ˆå–æ¶ˆæ³¨é‡Šå³å¯ä½¿ç”¨ï¼‰ï¼š
# https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/BaseFilter/sections/adservers.txt
# https://easylist.to/easylist/easylist.txt
# https://easylist.to/easylist/easyprivacy.txt
EOF
        fi
        
        if [ -f "rules/sources/white.txt" ]; then
          echo "âœ… white.txt å­˜åœ¨"
          echo "æ–‡ä»¶è¡Œæ•°: $(wc -l < rules/sources/white.txt)"
          echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          head -10 rules/sources/white.txt
        else
          echo "âŒ white.txt ä¸å­˜åœ¨ï¼Œåˆ›å»ºç¤ºä¾‹æ–‡ä»¶"
          cat > rules/sources/white.txt << 'EOF'
# ç™½åå•è§„åˆ™æº
# è¯·åœ¨æ­¤æ–‡ä»¶ä¸­æ·»åŠ æ‚¨è¦é‡‡é›†çš„ç™½åå•è§„åˆ™æºURL
# æ¯è¡Œä¸€ä¸ªURLï¼Œä»¥#å¼€å¤´çš„è¡Œæ˜¯æ³¨é‡Š

# ç¤ºä¾‹ï¼ˆå–æ¶ˆæ³¨é‡Šå³å¯ä½¿ç”¨ï¼‰ï¼š
# https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/BaseFilter/sections/allowlist.txt
# https://raw.githubusercontent.com/anudeepND/whitelist/master/domains/whitelist.txt
EOF
        fi
    
    - name: ç”Ÿæˆè§„åˆ™ï¼ˆå¢å¼ºæ¨¡å¼ï¼‰
      run: |
        python run.py --mode enhanced --verbose
    
    - name: éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la rules/outputs/
        echo ""
        echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
        for file in rules/outputs/*.txt; do
          lines=$(wc -l < "$file" | tr -d ' ')
          size=$(du -h "$file" | cut -f1)
          echo "$(basename "$file"): $lines è¡Œ, $size"
        done
        echo ""
        echo "ğŸ“ˆ è§„åˆ™ç»Ÿè®¡:"
        if [ -f "rules/outputs/info.json" ]; then
          cat rules/outputs/info.json | python3 -c "
import sys,json
try:
    data=json.load(sys.stdin)
    print(f'é»‘åå•: {data[\"counts\"][\"blacklist\"]:,}')
    print(f'ç™½åå•: {data[\"counts\"][\"whitelist\"]:,}')
    print(f'è¿‡æ»¤å: {data[\"counts\"][\"filtered\"]:,}')
    print(f'å¢å¼ºæ·»åŠ : {data[\"counts\"][\"enhanced_added\"]:,}')
except Exception as e:
    print(f'è§£æinfo.jsonå¤±è´¥: {e}')
"
        fi
    
    - name: æäº¤æ›´æ”¹
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git status --porcelain | grep -q '.'; then
          git add -A
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°è§„åˆ™ $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… å·²æäº¤æ›´æ”¹"
        else
          echo "ğŸ“­ æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
        fi
