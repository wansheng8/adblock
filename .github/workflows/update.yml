name: æ›´æ–°å¹¿å‘Šè¿‡æ»¤è§„åˆ™

on:
  schedule:
    # æ¯å¤©UTC 18:00 (åŒ—äº¬æ—¶é—´02:00)
    - cron: '0 18 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

jobs:
  generate-rules:
    runs-on: ubuntu-latest
    
    # è®¾ç½®æƒé™
    permissions:
      contents: write  # å…è®¸å†™å…¥ä»“åº“
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        # ä½¿ç”¨å®Œæ•´å†å²è®°å½•ä»¥ä¾¿gitèƒ½æ­£å¸¸å·¥ä½œ
        fetch-depth: 0
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests PyYAML urllib3
    
    - name: åˆ›å»ºç›®å½•ç»“æ„
      run: |
        mkdir -p rules/sources rules/outputs logs reports backups cache
        echo "ğŸ“ ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ"
    
    - name: æ£€æŸ¥å¹¶åˆ›å»ºæºæ–‡ä»¶
      run: |
        echo "ğŸ“ æ£€æŸ¥æºæ–‡ä»¶..."
        
        # æ£€æŸ¥é»‘åå•æºæ–‡ä»¶
        if [ ! -f "rules/sources/black.txt" ] || [ ! -s "rules/sources/black.txt" ]; then
          echo "âš ï¸  black.txt ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œåˆ›å»ºç¤ºä¾‹æ–‡ä»¶"
          cat > rules/sources/black.txt << 'EOF'
# å¹¿å‘Šè¿‡æ»¤è§„åˆ™æº - é»‘åå•
# è¯·åœ¨æ­¤æ–‡ä»¶ä¸­æ·»åŠ æ‚¨è¦é‡‡é›†çš„é»‘åå•è§„åˆ™æºURL
# æ¯è¡Œä¸€ä¸ªURLï¼Œä»¥#å¼€å¤´çš„è¡Œæ˜¯æ³¨é‡Š

# ç¤ºä¾‹ï¼ˆå–æ¶ˆæ³¨é‡Šå³å¯ä½¿ç”¨ï¼‰ï¼š
https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/BaseFilter/sections/adservers.txt
https://easylist.to/easylist/easylist.txt
https://easylist.to/easylist/easyprivacy.txt
https://secure.fanboy.co.nz/fanboy-annoyance.txt
https://secure.fanboy.co.nz/fanboy-social.txt
EOF
          echo "âœ… åˆ›å»º black.txt å®Œæˆ"
        else
          echo "âœ… black.txt å·²å­˜åœ¨"
          echo "ğŸ“„ å†…å®¹é¢„è§ˆï¼š"
          head -20 rules/sources/black.txt
        fi
        
        # æ£€æŸ¥ç™½åå•æºæ–‡ä»¶
        if [ ! -f "rules/sources/white.txt" ] || [ ! -s "rules/sources/white.txt" ]; then
          echo "âš ï¸  white.txt ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œåˆ›å»ºç¤ºä¾‹æ–‡ä»¶"
          cat > rules/sources/white.txt << 'EOF'
# ç™½åå•è§„åˆ™æº
# è¯·åœ¨æ­¤æ–‡ä»¶ä¸­æ·»åŠ æ‚¨è¦é‡‡é›†çš„ç™½åå•è§„åˆ™æºURL
# æ¯è¡Œä¸€ä¸ªURLï¼Œä»¥#å¼€å¤´çš„è¡Œæ˜¯æ³¨é‡Š

# ç¤ºä¾‹ï¼ˆå–æ¶ˆæ³¨é‡Šå³å¯ä½¿ç”¨ï¼‰ï¼š
https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/BaseFilter/sections/allowlist.txt
https://raw.githubusercontent.com/anudeepND/whitelist/master/domains/whitelist.txt
EOF
          echo "âœ… åˆ›å»º white.txt å®Œæˆ"
        else
          echo "âœ… white.txt å·²å­˜åœ¨"
          echo "ğŸ“„ å†…å®¹é¢„è§ˆï¼š"
          head -20 rules/sources/white.txt
        fi
        
        # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
        echo "ğŸ“Š æ–‡ä»¶å¤§å°ç»Ÿè®¡ï¼š"
        ls -lh rules/sources/
    
    - name: ç”Ÿæˆå¹¿å‘Šè¿‡æ»¤è§„åˆ™
      run: |
        echo "ğŸš€ å¼€å§‹ç”Ÿæˆå¹¿å‘Šè¿‡æ»¤è§„åˆ™..."
        echo "å½“å‰å·¥ä½œç›®å½•ï¼š$(pwd)"
        echo "ç›®å½•å†…å®¹ï¼š"
        ls -la
        
        # è¿è¡Œè§„åˆ™ç”Ÿæˆå™¨
        python run.py --mode enhanced --verbose
        
        echo "âœ… è§„åˆ™ç”Ÿæˆå®Œæˆ"
    
    - name: éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨ï¼š"
        ls -la rules/outputs/ || echo "rules/outputs/ ç›®å½•ä¸å­˜åœ¨"
        
        if [ -d "rules/outputs/" ]; then
          echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡ï¼š"
          for file in rules/outputs/*.txt; do
            if [ -f "$file" ]; then
              lines=$(wc -l < "$file" 2>/dev/null || echo "0")
              size=$(du -h "$file" 2>/dev/null | cut -f1 || echo "0B")
              echo "  $(basename "$file"): $lines è¡Œ, $size"
            fi
          done
          
          echo "ğŸ“ˆ è§„åˆ™ç»Ÿè®¡ï¼š"
          if [ -f "rules/outputs/info.json" ]; then
            python3 -c "
import json, sys
try:
    with open('rules/outputs/info.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    print(f'é»‘åå•: {data[\"counts\"][\"blacklist\"]:,}')
    print(f'ç™½åå•: {data[\"counts\"][\"whitelist\"]:,}')
    print(f'è¿‡æ»¤å: {data[\"counts\"][\"filtered\"]:,}')
    print(f'å¢å¼ºæ·»åŠ : {data[\"counts\"][\"enhanced_added\"]:,}')
except Exception as e:
    print(f'è§£æinfo.jsonå¤±è´¥: {e}')
"
          else
            echo "âŒ info.json æ–‡ä»¶ä¸å­˜åœ¨"
          fi
        else
          echo "âŒ rules/outputs/ ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
        fi
    
    - name: é…ç½®Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        echo "âœ… Gité…ç½®å®Œæˆ"
    
    - name: æ£€æŸ¥æ›´æ”¹å¹¶æäº¤
      run: |
        echo "ğŸ” æ£€æŸ¥æ–‡ä»¶æ›´æ”¹..."
        git status
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if [ -n "$(git status --porcelain)" ]; then
          echo "ğŸ“ æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤"
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹çš„æ–‡ä»¶
          git add -A
          
          # æäº¤æ›´æ”¹
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°å¹¿å‘Šè¿‡æ»¤è§„åˆ™ $(date +'%Y-%m-%d %H:%M:%S')"
          
          # æ¨é€æ›´æ”¹
          echo "ğŸš€ æ¨é€æ›´æ”¹åˆ°ä»“åº“..."
          git push origin main
          
          echo "âœ… æ›´æ”¹å·²æäº¤å¹¶æ¨é€"
        else
          echo "ğŸ“­ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹"
        fi
    
    - name: æ¸…ç†ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -rf cache/ || true
        rm -rf logs/ || true
        echo "âœ… æ¸…ç†å®Œæˆ"
