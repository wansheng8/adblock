name: Auto Update Rules

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 18:00 è¿è¡Œï¼ˆä¸Šæµ·æ—¶é—´æ¬¡æ—¥å‡Œæ™¨ 2:00ï¼‰
    - cron: '0 18 * * *'
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'rules/sources/**'

jobs:
  update-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ§¹ æ¸…ç†æ—§è§„åˆ™
        run: |
          rm -rf rules/outputs/*
          echo "æ—§è§„åˆ™å·²æ¸…ç†"
      
      - name: ğŸš€ è¿è¡Œè§„åˆ™æ”¶é›†å™¨
        env:
          TZ: Asia/Shanghai
        run: python run.py
      
      - name: ğŸ“Š æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶
        run: |
          echo "=== ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨ ==="
          ls -la rules/outputs/
          echo -e "\n=== è§„åˆ™ç»Ÿè®¡ ==="
          cat rules/outputs/info.json
      
      - name: ğŸ“ æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: git-check
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "ğŸŸ¢ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ğŸŸ¡ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            git add .
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°è§„åˆ™ - $(date -u +'%Y-%m-%d %H:%M:%S') UTC"
          fi
      
      - name: ğŸš€ æ¨é€å˜æ›´
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git push origin main
          echo "âœ… å˜æ›´å·²æ¨é€åˆ°ä»“åº“"
      
      - name: ğŸ“¦ ç”Ÿæˆæäº¤ä¿¡æ¯
        if: always()
        run: |
          echo "=== æ›´æ–°ä»»åŠ¡å®Œæˆ ==="
          echo "æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S') UTC"
          echo "ä¸Šæµ·æ—¶é—´: $(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S')"
      
      - name: ğŸ’¬ æ›´æ–°å®Œæˆé€šçŸ¥
        if: success()
        run: |
          echo "âœ… å¹¿å‘Šè§„åˆ™æ›´æ–°å®Œæˆï¼"
          echo "ğŸ“… ä¸‹æ¬¡è‡ªåŠ¨æ›´æ–°: æ¯å¤© UTC 18:00 (ä¸Šæµ·æ—¶é—´ 02:00)"
