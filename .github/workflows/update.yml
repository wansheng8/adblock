name: æ›´æ–°å¹¿å‘Šè¿‡æ»¤è§„åˆ™

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´02:00è¿è¡Œ (UTC 18:00)
    - cron: '0 18 * * *'
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

jobs:
  generate-rules:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests PyYAML urllib3
    
    - name: åˆ›å»ºå¿…è¦ç›®å½•
      run: |
        mkdir -p rules/sources rules/outputs logs cache reports backups
    
    - name: åˆ›å»ºé»˜è®¤æºæ–‡ä»¶
      run: |
        cat > rules/sources/black.txt << 'EOF'
        # å¹¿å‘Šè¿‡æ»¤è§„åˆ™æº
        # é»˜è®¤å†…ç½®æº
        https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/BaseFilter/sections/adservers.txt
        https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/BaseFilter/sections/tracking.txt
        https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/BaseFilter/sections/analytics.txt
        https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/BaseFilter/sections/banners.txt
        https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/BaseFilter/sections/social.txt
        https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/BaseFilter/sections/i18n.txt
        EOF
        
        cat > rules/sources/white.txt << 'EOF'
        # ç™½åå•è§„åˆ™æº
        https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/BaseFilter/sections/whitelist.txt
        EOF
    
    - name: ç”Ÿæˆè§„åˆ™ï¼ˆå¢žå¼ºæ¨¡å¼ï¼‰
      run: |
        python run.py --mode enhanced --verbose
    
    - name: éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        echo "ðŸ“ ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la rules/outputs/
        echo ""
        echo "ðŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
        for file in rules/outputs/*.txt; do
          lines=$(wc -l < "$file" | tr -d ' ')
          size=$(du -h "$file" | cut -f1)
          echo "$(basename "$file"): $lines è¡Œ, $size"
        done
        echo ""
        echo "ðŸ“ˆ è§„åˆ™ç»Ÿè®¡:"
        if [ -f "rules/outputs/info.json" ]; then
          cat rules/outputs/info.json | python3 -c "import sys,json; data=json.load(sys.stdin); print(f'é»‘åå•: {data[\"counts\"][\"blacklist\"]:,}'); print(f'ç™½åå•: {data[\"counts\"][\"whitelist\"]:,}'); print(f'è¿‡æ»¤åŽ: {data[\"counts\"][\"filtered\"]:,}')"
        fi
    
    - name: æäº¤æ›´æ”¹
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git status --porcelain | grep -q '.'; then
          git add -A
          git commit -m "ðŸ¤– è‡ªåŠ¨æ›´æ–°è§„åˆ™ $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… å·²æäº¤æ›´æ”¹"
        else
          echo "ðŸ“­ æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
        fi
