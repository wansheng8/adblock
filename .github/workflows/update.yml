name: Update Rules

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´0ç‚¹è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  update-rules:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Clean previous outputs
      run: |
        rm -rf rules/outputs/*
        echo "[]" > rules/outputs/info.json
    
    - name: Run update script
      run: python run.py
    
    - name: Update README.md
      run: python -c "
import json
from datetime import datetime, timezone

# è¯»å–info.jsonè·å–æ›´æ–°æ—¶é—´
with open('rules/outputs/info.json', 'r', encoding='utf-8') as f:
    info = json.load(f)

# ç”ŸæˆREADME.mdå†…å®¹
readme_content = '''# ğŸ›¡ï¸ Adblock Rules Collector

ä¸€ä¸ªç²¾å‡†è¶…çº§æ™ºèƒ½çš„å¹¿å‘Šè¿‡æ»¤è§„åˆ™é›†åˆå™¨ï¼Œè‡ªåŠ¨ä»å¤šä¸ªè§„åˆ™æºèšåˆã€å»é‡å’Œä¼˜åŒ–å¹¿å‘Šè¿‡æ»¤è§„åˆ™ã€‚

## ğŸ“‹ è®¢é˜…é“¾æ¥

| è§„åˆ™ç±»å‹ | åŸå§‹é“¾æ¥ | è®¢é˜…é“¾æ¥ | è§„åˆ™æ•°é‡ |
|---------|---------|---------|---------|
| Adblock è§„åˆ™ | [åŸå§‹é“¾æ¥](https://github.com/wansheng8/adblock/blob/main/rules/outputs/ad.txt) | `https://raw.githubusercontent.com/wansheng8/adblock/main/rules/outputs/ad.txt` | {ad_count} |
| DNS è¿‡æ»¤è§„åˆ™ | [åŸå§‹é“¾æ¥](https://github.com/wansheng8/adblock/blob/main/rules/outputs/dns.txt) | `https://raw.githubusercontent.com/wansheng8/adblock/main/rules/outputs/dns.txt` | {dns_count} |
| Hosts è§„åˆ™ | [åŸå§‹é“¾æ¥](https://github.com/wansheng8/adblock/blob/main/rules/outputs/hosts.txt) | `https://raw.githubusercontent.com/wansheng8/adblock/main/rules/outputs/hosts.txt` | {hosts_count} |
| é»‘åå•è§„åˆ™ | [åŸå§‹é“¾æ¥](https://github.com/wansheng8/adblock/blob/main/rules/outputs/black.txt) | `https://raw.githubusercontent.com/wansheng8/adblock/main/rules/outputs/black.txt` | {black_count} |
| ç™½åå•è§„åˆ™ | [åŸå§‹é“¾æ¥](https://github.com/wansheng8/adblock/blob/main/rules/outputs/white.txt) | `https://raw.githubusercontent.com/wansheng8/adblock/main/rules/outputs/white.txt` | {white_count} |

## ğŸ•’ æœ€æ–°æ›´æ–°æ—¶é—´

**æœ€åæ›´æ–°:** {update_time} (UTC)

> âš ï¸ æ³¨æ„ï¼šè§„åˆ™æ¯24å°æ—¶è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ï¼Œæ‚¨ä¹Ÿå¯ä»¥åœ¨Adblockæ’ä»¶ä¸­è®¾ç½®æ›´é¢‘ç¹çš„æ›´æ–°é—´éš”ã€‚
'''

# è·å–è§„åˆ™æ•°é‡
ad_count = sum(1 for item in info if item['type'] == 'adblock')
dns_count = sum(1 for item in info if item['type'] == 'dns')
hosts_count = sum(1 for item in info if item['type'] == 'hosts')
black_count = sum(1 for item in info if item['type'] == 'blacklist')
white_count = sum(1 for item in info if item['type'] == 'whitelist')

# æ ¼å¼åŒ–æ›´æ–°æ—¶é—´
update_time = datetime.now(timezone.utc).strftime('%Y-%m-%d %H:%M:%S')

# å¡«å……æ¨¡æ¿
readme_content = readme_content.format(
    ad_count=ad_count,
    dns_count=dns_count,
    hosts_count=hosts_count,
    black_count=black_count,
    white_count=white_count,
    update_time=update_time
)

# å†™å…¥README.md
with open('README.md', 'w', encoding='utf-8') as f:
    f.write(readme_content)
"
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "ğŸš€ Auto-update rules $(date -u +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
        git push origin main
