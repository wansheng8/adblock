name: æ›´æ–°å¹¿å‘Šè¿‡æ»¤è§„åˆ™

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´02:00è¿è¡Œ
    - cron: '0 18 * * *'
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  generate-rules:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests pyyaml tldextract psutil
    
    - name: ç”Ÿæˆè§„åˆ™
      run: |
        python run.py --mode enhanced --verbose
      
    - name: éªŒè¯è§„åˆ™
      run: |
        echo "éªŒè¯è§„åˆ™æ–‡ä»¶..."
        ls -la rules/outputs/
        wc -l rules/outputs/*.txt
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        for file in rules/outputs/*.txt; do
          echo "æ£€æŸ¥ $file"
          head -5 "$file"
          echo "..."
          tail -5 "$file"
          echo ""
        done
    
    - name: æäº¤æ›´æ”¹
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if [[ -n $(git status --porcelain) ]]; then
          git add -A
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°è§„åˆ™ $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        else
          echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
        fi
    
    - name: åˆ›å»ºRelease
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "v$(date +'%Y%m%d')"
        name: "è§„åˆ™æ›´æ–° $(date +'%Y-%m-%d')"
        body: |
          ### ğŸš€ è‡ªåŠ¨è§„åˆ™æ›´æ–°
          
          **ç”Ÿæˆæ—¶é—´:** $(date +'%Y-%m-%d %H:%M:%S')
          
          **è§„åˆ™ç»Ÿè®¡:**
          - Adblockè§„åˆ™: [ad.txt](https://raw.githubusercontent.com/${{ github.repository }}/main/rules/outputs/ad.txt)
          - DNSè§„åˆ™: [dns.txt](https://raw.githubusercontent.com/${{ github.repository }}/main/rules/outputs/dns.txt)
          - Hostsè§„åˆ™: [hosts.txt](https://raw.githubusercontent.com/${{ github.repository }}/main/rules/outputs/hosts.txt)
          - å¢å¼ºè§„åˆ™: [enhanced.txt](https://raw.githubusercontent.com/${{ github.repository }}/main/rules/outputs/enhanced.txt)
          
          **ä½¿ç”¨è¯´æ˜:**
          1. å¤åˆ¶è®¢é˜…é“¾æ¥åˆ°æ‚¨çš„å¹¿å‘Šæ‹¦æˆªå™¨
          2. æˆ–ä¸‹è½½æ–‡ä»¶åº”ç”¨åˆ°DNS/Hosts
          
          ---
          
          *æœ¬æ¬¡æ›´æ–°ç”±GitHub Actionsè‡ªåŠ¨æ‰§è¡Œ*
          
        draft: false
        prerelease: false
        files: |
          rules/outputs/*.txt
          rules/outputs/*.json
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
