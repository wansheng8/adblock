name: Update Adblock Rules

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´0ç‚¹è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'rules/sources/**'

jobs:
  update-rules:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•ï¼Œç”¨äºåˆ é™¤æ—§æ–‡ä»¶
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Clean previous outputs
      run: |
        rm -rf rules/outputs/*
    
    - name: Run adblock updater
      run: python run.py
    
    - name: Generate README
      run: |
        python -c "
        import json
        import datetime
        from pathlib import Path
        
        # è¯»å–ä¿¡æ¯
        with open('rules/outputs/info.json', 'r', encoding='utf-8') as f:
            info = json.load(f)
        
        # ç”ŸæˆREADME
        readme_content = '''# Adblock Rules Collection ğŸ›¡ï¸

ä¸€ä¸ªç²¾å‡†è¶…çº§æ™ºèƒ½çš„å¹¿å‘Šè¿‡æ»¤è§„åˆ™é›†åˆå™¨ï¼Œè‡ªåŠ¨èšåˆå¤šä¸ªä¼˜è´¨è§„åˆ™æºï¼Œç”Ÿæˆå¤šç§æ ¼å¼çš„è¿‡æ»¤è§„åˆ™ã€‚

## è®¢é˜…é“¾æ¥ ğŸ“¡

| è§„åˆ™ç±»å‹ | æ–‡ä»¶æ ¼å¼ | è§„åˆ™æ•°é‡ | è®¢é˜…é“¾æ¥ |
|---------|---------|---------|---------|
| Adblock è§„åˆ™ | ad.txt | {ad_count} | [ç‚¹å‡»è®¢é˜…](https://raw.githubusercontent.com/wansheng8/adblock/main/rules/outputs/ad.txt) |
| DNS æ‹¦æˆªè§„åˆ™ | dns.txt | {dns_count} | [ç‚¹å‡»è®¢é˜…](https://raw.githubusercontent.com/wansheng8/adblock/main/rules/outputs/dns.txt) |
| Hosts è§„åˆ™ | hosts.txt | {hosts_count} | [ç‚¹å‡»è®¢é˜…](https://raw.githubusercontent.com/wansheng8/adblock/main/rules/outputs/hosts.txt) |
| é»‘åå•è§„åˆ™ | black.txt | {black_count} | [ç‚¹å‡»è®¢é˜…](https://raw.githubusercontent.com/wansheng8/adblock/main/rules/outputs/black.txt) |
| ç™½åå•è§„åˆ™ | white.txt | {white_count} | [ç‚¹å‡»è®¢é˜…](https://raw.githubusercontent.com/wansheng8/adblock/main/rules/outputs/white.txt) |

## æœ€æ–°æ›´æ–°æ—¶é—´ â°

**{update_time}**

*æ³¨æ„ï¼šè§„åˆ™æ¯å¤©è‡ªåŠ¨æ›´æ–°ï¼Œè¯·å®šæœŸè·å–æœ€æ–°ç‰ˆæœ¬ä»¥è·å¾—æœ€ä½³é˜²æŠ¤æ•ˆæœã€‚*
'''
        
        # æ›¿æ¢å˜é‡
        readme_content = readme_content.format(
            ad_count=info.get('ad_count', 0),
            dns_count=info.get('dns_count', 0),
            hosts_count=info.get('hosts_count', 0),
            black_count=info.get('black_count', 0),
            white_count=info.get('white_count', 0),
            update_time=info.get('update_time', 'æœªçŸ¥')
        )
        
        # å†™å…¥README
        with open('README.md', 'w', encoding='utf-8') as f:
            f.write(readme_content)
        '''
    
    - name: Commit and push changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # åˆ é™¤æ—§çš„è§„åˆ™æ–‡ä»¶ï¼ˆç¡®ä¿æ¸…ç†ï¼‰
        git rm -f rules/outputs/* 2>/dev/null || true
        
        # æ·»åŠ æ–°æ–‡ä»¶
        git add -f rules/outputs/* README.md
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ”„ Update adblock rules [$(date +'%Y-%m-%d %H:%M:%S')]"
          git push
        fi
