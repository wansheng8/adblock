name: è‡ªåŠ¨æ›´æ–°è§„åˆ™

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 02:00 è¿è¡Œ
    - cron: '0 18 * * *'
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘æŒ‰é’®
  push:
    branches: [ main ]
    paths:
      - 'rules/sources/*'
      - 'run.py'

env:
  TZ: Asia/Shanghai  # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·æ—¶é—´
  PYTHON_VERSION: '3.10'

jobs:
  update-rules:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # å…è®¸å†™å…¥å†…å®¹
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # è·å–å®Œæ•´å†å²
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: ç”Ÿæˆå¹¿å‘Šè¿‡æ»¤è§„åˆ™
      run: python run.py
    
    - name: é…ç½®Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
    
    - name: æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
      id: check_changes
      run: |
        if git diff --quiet; then
          echo "æ²¡æœ‰å˜åŒ–éœ€è¦æäº¤"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "æ£€æµ‹åˆ°å˜åŒ–"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: æäº¤å˜æ›´
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        # è·å–åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
        git add .
        # æäº¤
        git commit -m "ğŸ”„ è§„åˆ™æ›´æ–°: $BEIJING_TIME (åŒ—äº¬æ—¶é—´)" \
          -m "âœ… è‡ªåŠ¨æ›´æ–°å®Œæˆ" \
          -m "ğŸ“… ç‰ˆæœ¬: $(date '+%Y%m%d')"
        # æ¨é€
        git push origin main
    
    - name: å®Œæˆé€šçŸ¥
      run: |
        if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
          echo "âœ… è§„åˆ™å·²æ›´æ–°å¹¶æäº¤"
          echo "ğŸ“… æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        else
          echo "â„¹ï¸  æ²¡æœ‰å˜åŒ–éœ€è¦æäº¤"
        fi
