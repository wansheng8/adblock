name: æ›´æ–°å¹¿å‘Šè¿‡æ»¤è§„åˆ™

on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  generate-rules:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests PyYAML urllib3
    
    - name: åˆ›å»ºç›®å½•ç»“æ„
      run: |
        mkdir -p rules/sources rules/outputs logs reports backups cache
    
    - name: æ£€æŸ¥æºæ–‡ä»¶
      run: |
        if [ ! -f "rules/sources/black.txt" ]; then
          echo "âŒ black.txt ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºæ–‡ä»¶"
          touch rules/sources/black.txt
        fi
        
        if [ ! -f "rules/sources/white.txt" ]; then
          echo "âŒ white.txt ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºæ–‡ä»¶"
          touch rules/sources/white.txt
        fi
        
        echo "ğŸ“Š æºæ–‡ä»¶å¤§å°:"
        wc -l rules/sources/black.txt
        wc -l rules/sources/white.txt
    
    - name: ç”Ÿæˆå¹¿å‘Šè¿‡æ»¤è§„åˆ™
      run: |
        python run.py --mode enhanced --verbose
    
    - name: éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        if [ -d "rules/outputs/" ]; then
          echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶:"
          ls -la rules/outputs/
          
          echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
          for file in rules/outputs/*.txt; do
            if [ -f "$file" ]; then
              lines=$(wc -l < "$file" 2>/dev/null || echo "0")
              size=$(du -h "$file" 2>/dev/null | cut -f1 || echo "0B")
              echo "$(basename "$file"): $lines è¡Œ, $size"
            fi
          done
        else
          echo "âŒ æ²¡æœ‰ç”Ÿæˆè¾“å‡ºæ–‡ä»¶"
          exit 1
        fi
    
    - name: é…ç½®Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: æäº¤æ›´æ”¹
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          git add -A
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°å¹¿å‘Šè¿‡æ»¤è§„åˆ™ $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin main
          echo "âœ… æ›´æ”¹å·²æäº¤"
        else
          echo "ğŸ“­ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹"
        fi
